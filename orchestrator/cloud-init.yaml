#cloud-config
# Orchestrator Droplet - Initial Setup
# This runs once when the droplet is first created

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - unattended-upgrades

# Disable SSH password authentication (key-only or web terminal)
ssh_pwauth: false

# Create non-root user for running services
users:
  - name: orchestrator
    groups: docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

write_files:
  # UFW configuration - only allow HTTPS
  - path: /etc/ufw/applications.d/orchestrator
    content: |
      [Orchestrator]
      title=Orchestrator HTTPS
      description=HTTPS access for orchestrator
      ports=443/tcp

  # Docker daemon configuration
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "10m",
          "max-file": "3"
        },
        "storage-driver": "overlay2"
      }

  # Fail2ban configuration for additional hardening
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 1h
      findtime = 10m
      maxretry = 5
      
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log

  # Systemd service for orchestrator
  - path: /etc/systemd/system/orchestrator.service
    content: |
      [Unit]
      Description=Orchestrator Control Panel
      Requires=docker.service
      After=docker.service
      
      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/orchestrator
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      
      [Install]
      WantedBy=multi-user.target

runcmd:
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Configure firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 443/tcp
  - ufw --force enable

  # Start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Clone and setup orchestrator
  - mkdir -p /opt/orchestrator
  - cd /opt/orchestrator
  
  # Create placeholder for git clone (user will update with their repo URL)
  - |
    cat > /opt/orchestrator/SETUP_REQUIRED.md << 'EOF'
    # Setup Required
    
    Clone your sandbox-network repo here:
    
    ```bash
    cd /opt/orchestrator
    git clone https://github.com/YOUR_USERNAME/sandbox-network.git .
    ```
    
    Then start services:
    ```bash
    docker compose up -d
    ```
    
    Access https://YOUR_DOMAIN/setup to complete TOTP configuration.
    EOF

  # Set permissions
  - chown -R orchestrator:orchestrator /opt/orchestrator

  # Enable auto-updates
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades
