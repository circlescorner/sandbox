{% extends "base.html" %}

{% block title %}Dashboard - Sandbox Orchestrator{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">Dashboard</h1>

<!-- Sandbox Status Card -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üñ•Ô∏è Sandbox Status</h2>
        <span class="status-badge {% if sandbox_status.running %}status-running{% else %}status-stopped{% endif %}">
            {{ sandbox_status.status }}
        </span>
    </div>
    
    <div class="grid grid-2">
        <div>
            {% if sandbox_status.running %}
            <p><strong>Droplet ID:</strong> <code>{{ sandbox_status.droplet_id }}</code></p>
            <p><strong>Private IP:</strong> <code>{{ sandbox_status.private_ip }}</code></p>
            <p><strong>Size:</strong> {{ sandbox_status.size }}</p>
            <p><strong>Region:</strong> {{ sandbox_status.region }}</p>
            {% else %}
            <p style="color: var(--text-secondary);">No sandbox currently running.</p>
            {% if not snapshot_id %}
            <p style="color: var(--warning);">‚ö†Ô∏è No snapshot configured. Build one first.</p>
            {% endif %}
            {% endif %}
        </div>
        
        <div style="text-align: right;">
            {% if sandbox_status.running %}
            <button class="btn btn-danger" onclick="killSandbox()">
                üóëÔ∏è Kill Sandbox
            </button>
            <a href="/terminal" class="btn btn-outline" style="margin-left: 0.5rem;">
                üíª Terminal
            </a>
            {% else %}
            <button class="btn btn-primary" onclick="spawnSandbox()" {% if not snapshot_id %}disabled{% endif %}>
                üöÄ Spawn Sandbox
            </button>
            {% endif %}
            
            <button class="btn btn-outline" onclick="refreshStatus()" style="margin-left: 0.5rem;">
                üîÑ Refresh
            </button>
        </div>
    </div>
</div>

<!-- Network Configuration Card -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üåê Network Configuration</h2>
        <button class="btn btn-primary" onclick="saveNetworkConfig()">
            üíæ Save Config
        </button>
    </div>
    
    <div class="grid grid-2">
        {% for container_name, config in network_config.containers.items() %}
        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 6px;">
            <h3 style="margin-bottom: 1rem;">{{ container_name }}</h3>
            
            <div class="form-group">
                <label class="form-label">Egress Policy</label>
                <select class="form-input" id="egress-{{ container_name }}" onchange="updateAllowedDomains('{{ container_name }}')">
                    <option value="none" {% if config.egress == 'none' %}selected{% endif %}>None (Isolated)</option>
                    <option value="allowlist" {% if config.egress == 'allowlist' %}selected{% endif %}>Allowlist</option>
                    <option value="all" {% if config.egress == 'all' %}selected{% endif %}>All (Unrestricted)</option>
                </select>
            </div>
            
            <div class="form-group" id="domains-group-{{ container_name }}" style="{% if config.egress != 'allowlist' %}display: none;{% endif %}">
                <label class="form-label">Allowed Domains</label>
                <textarea 
                    class="form-input" 
                    id="domains-{{ container_name }}"
                    placeholder="One domain per line, e.g.:&#10;api.runpod.ai&#10;*.runpod.net"
                    rows="4"
                >{{ config.allowed_domains | join('\n') }}</textarea>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Inter-container Communication -->
    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px;">
        <h3 style="margin-bottom: 1rem;">Inter-Container Communication</h3>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" id="inter-container-enabled" 
                    {% if network_config.inter_container.enabled %}checked{% endif %}
                    onchange="toggleInterContainer()">
                <span>Enable communication between containers</span>
            </label>
        </div>
        
        <div id="inter-container-rules" style="{% if not network_config.inter_container.enabled %}display: none;{% endif %}">
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                Configure which containers can communicate with each other.
            </p>
            <div id="rules-list">
                {% for rule in network_config.inter_container.rules %}
                <div class="rule-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                    <select class="form-input" style="width: auto;">
                        <option value="container-1" {% if rule.from == 'container-1' %}selected{% endif %}>container-1</option>
                        <option value="container-2" {% if rule.from == 'container-2' %}selected{% endif %}>container-2</option>
                        <option value="container-3" {% if rule.from == 'container-3' %}selected{% endif %}>container-3</option>
                        <option value="container-4" {% if rule.from == 'container-4' %}selected{% endif %}>container-4</option>
                    </select>
                    <span>‚Üí</span>
                    <select class="form-input" style="width: auto;">
                        <option value="container-1" {% if rule.to == 'container-1' %}selected{% endif %}>container-1</option>
                        <option value="container-2" {% if rule.to == 'container-2' %}selected{% endif %}>container-2</option>
                        <option value="container-3" {% if rule.to == 'container-3' %}selected{% endif %}>container-3</option>
                        <option value="container-4" {% if rule.to == 'container-4' %}selected{% endif %}>container-4</option>
                    </select>
                    <input type="text" class="form-input" style="width: 120px;" placeholder="Ports (8080)" value="{{ rule.ports | join(',') }}">
                    <button class="btn btn-outline" onclick="removeRule(this)">‚úï</button>
                </div>
                {% endfor %}
            </div>
            <button class="btn btn-outline" onclick="addRule()">+ Add Rule</button>
        </div>
    </div>
</div>

<!-- Snapshot Management Card -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üì∏ Snapshot Management</h2>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            {% if snapshot_id %}
            <p><strong>Current Snapshot:</strong> <code>{{ snapshot_id }}</code></p>
            {% else %}
            <p style="color: var(--text-secondary);">No snapshot configured.</p>
            {% endif %}
        </div>
        
        <button class="btn btn-outline" onclick="buildSnapshot()" id="build-snapshot-btn">
            üî® Build New Snapshot
        </button>
    </div>
    
    <div id="snapshot-progress" style="display: none; margin-top: 1rem;">
        <p style="color: var(--text-secondary);">
            Building snapshot... This takes 3-5 minutes.
        </p>
        <div style="background: var(--bg-tertiary); border-radius: 4px; height: 8px; overflow: hidden; margin-top: 0.5rem;">
            <div id="snapshot-progress-bar" style="background: var(--accent); height: 100%; width: 0%; transition: width 0.5s;"></div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">‚ö° Quick Actions</h2>
    </div>
    
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="/terminal" class="terminal-link">
            <svg class="terminal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4 17 10 11 4 5"></polyline>
                <line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
            Orchestrator Terminal
        </a>
        
        {% if sandbox_status.running %}
        <a href="/terminal?target=sandbox" class="terminal-link">
            <svg class="terminal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
            Sandbox Terminal
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function apiCall(endpoint, method = 'GET', body = null) {
        const options = {
            method,
            headers: { 'Content-Type': 'application/json' },
        };
        if (body) options.body = JSON.stringify(body);
        
        const response = await fetch(endpoint, options);
        return response.json();
    }
    
    async function spawnSandbox() {
        if (!confirm('Spawn a new sandbox droplet?')) return;
        
        const result = await apiCall('/api/sandbox/spawn', 'POST');
        alert(result.message || JSON.stringify(result));
        location.reload();
    }
    
    async function killSandbox() {
        if (!confirm('‚ö†Ô∏è This will destroy the sandbox and all data inside. Continue?')) return;
        
        const result = await apiCall('/api/sandbox/kill', 'POST');
        alert(result.message || JSON.stringify(result));
        location.reload();
    }
    
    async function refreshStatus() {
        location.reload();
    }
    
    function updateAllowedDomains(container) {
        const egress = document.getElementById(`egress-${container}`).value;
        const domainsGroup = document.getElementById(`domains-group-${container}`);
        domainsGroup.style.display = egress === 'allowlist' ? 'block' : 'none';
    }
    
    function toggleInterContainer() {
        const enabled = document.getElementById('inter-container-enabled').checked;
        document.getElementById('inter-container-rules').style.display = enabled ? 'block' : 'none';
    }
    
    function addRule() {
        const rulesList = document.getElementById('rules-list');
        const ruleHtml = `
            <div class="rule-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                <select class="form-input" style="width: auto;">
                    <option value="container-1">container-1</option>
                    <option value="container-2">container-2</option>
                    <option value="container-3">container-3</option>
                    <option value="container-4">container-4</option>
                </select>
                <span>‚Üí</span>
                <select class="form-input" style="width: auto;">
                    <option value="container-1">container-1</option>
                    <option value="container-2">container-2</option>
                    <option value="container-3">container-3</option>
                    <option value="container-4">container-4</option>
                </select>
                <input type="text" class="form-input" style="width: 120px;" placeholder="Ports (8080)">
                <button class="btn btn-outline" onclick="removeRule(this)">‚úï</button>
            </div>
        `;
        rulesList.insertAdjacentHTML('beforeend', ruleHtml);
    }
    
    function removeRule(btn) {
        btn.closest('.rule-item').remove();
    }
    
    async function saveNetworkConfig() {
        const containers = {};
        ['container-1', 'container-2', 'container-3', 'container-4'].forEach(name => {
            const egress = document.getElementById(`egress-${name}`).value;
            const domainsText = document.getElementById(`domains-${name}`).value;
            const domains = domainsText.split('\n').map(d => d.trim()).filter(d => d);
            containers[name] = { egress, allowed_domains: domains };
        });
        
        const interEnabled = document.getElementById('inter-container-enabled').checked;
        const rules = [];
        document.querySelectorAll('.rule-item').forEach(item => {
            const selects = item.querySelectorAll('select');
            const portsInput = item.querySelector('input');
            rules.push({
                from: selects[0].value,
                to: selects[1].value,
                ports: portsInput.value.split(',').map(p => parseInt(p.trim())).filter(p => !isNaN(p))
            });
        });
        
        const config = {
            containers,
            inter_container: { enabled: interEnabled, rules }
        };
        
        const result = await apiCall('/api/network/config', 'POST', config);
        alert(result.status === 'ok' ? 'Configuration saved!' : 'Error: ' + result.message);
    }
    
    async function buildSnapshot() {
        if (!confirm('Build a new sandbox snapshot? This will take 3-5 minutes.')) return;
        
        document.getElementById('build-snapshot-btn').disabled = true;
        document.getElementById('snapshot-progress').style.display = 'block';
        
        // Simulate progress
        let progress = 0;
        const progressBar = document.getElementById('snapshot-progress-bar');
        const interval = setInterval(() => {
            progress += 5;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 5000);
        
        const result = await apiCall('/api/snapshot/build', 'POST');
        
        clearInterval(interval);
        progressBar.style.width = '100%';
        
        setTimeout(() => {
            alert(result.status === 'ok' 
                ? `Snapshot created! ID: ${result.snapshot_id}` 
                : 'Error: ' + result.message);
            location.reload();
        }, 500);
    }
</script>
{% endblock %}
